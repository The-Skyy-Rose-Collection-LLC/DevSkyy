---
# DevSkyy Platform - Reusable Test Workflow
# Truth Protocol compliant testing with â‰¥90% coverage requirement
# FIXED: Added actions: write permission for caching and artifacts

name: Test Suite

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      coverage-threshold:
        description: 'Minimum coverage threshold'
        required: false
        type: number
        default: 90

# FIXED: Added actions: write permission
permissions:
  contents: read
  actions: write  # Required for actions/cache and actions/upload-artifact

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: devskyy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade "pip>=25.3,<26.0" "setuptools>=78.1.1,<79.0.0"
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install pytest pytest-cov pytest-asyncio pytest-mock pytest-django

    - name: Run pytest with coverage
      env:
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/devskyy_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key-for-ci
        JWT_SECRET_KEY: test-jwt-secret-for-ci
        ENCRYPTION_MASTER_KEY: dGVzdC1lbmNyeXB0aW9uLWtleS1mb3ItY2k=
        ENVIRONMENT: test
      run: |
        pytest \
          --cov=. \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=${{ inputs.coverage-threshold }} \
          --junitxml=pytest-report.xml \
          --verbose \
          --tb=short \
          -n auto

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          pytest-report.xml
          coverage.xml
          htmlcov/
        retention-days: 30

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f pytest-report.xml ]; then
          TESTS=$(xmllint --xpath 'string(//testsuite/@tests)' pytest-report.xml 2>/dev/null || echo "0")
          FAILURES=$(xmllint --xpath 'string(//testsuite/@failures)' pytest-report.xml 2>/dev/null || echo "0")
          ERRORS=$(xmllint --xpath 'string(//testsuite/@errors)' pytest-report.xml 2>/dev/null || echo "0")
          SKIPPED=$(xmllint --xpath 'string(//testsuite/@skipped)' pytest-report.xml 2>/dev/null || echo "0")

          echo "- **Total Tests**: $TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Failures**: $FAILURES" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors**: $ERRORS" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped**: $SKIPPED" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f coverage.xml ]; then
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', 0))" 2>/dev/null || echo "0")
          COVERAGE_PERCENT=$(python -c "print(f'{float($COVERAGE) * 100:.2f}')" 2>/dev/null || echo "0")
          echo "- **Coverage**: ${COVERAGE_PERCENT}%" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Truth Protocol**: Minimum coverage threshold is ${{ inputs.coverage-threshold }}%" >> $GITHUB_STEP_SUMMARY

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: devskyy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade "pip>=25.3,<26.0" "setuptools>=78.1.1,<79.0.0"
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install pytest pytest-asyncio pytest-docker

    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/devskyy_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key-for-ci
        JWT_SECRET_KEY: test-jwt-secret-for-ci
        ENCRYPTION_MASTER_KEY: dGVzdC1lbmNyeXB0aW9uLWtleS1mb3ItY2k=
        ENVIRONMENT: test
      run: |
        pytest tests/integration \
          --verbose \
          --tb=short \
          -n auto

    - name: Upload integration test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-reports
        path: |
          tests/integration/*.log
        retention-days: 7

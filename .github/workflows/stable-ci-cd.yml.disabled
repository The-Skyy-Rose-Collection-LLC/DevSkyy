name: ğŸš€ Stable CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: '50'

jobs:
  # ============================================================================
  # BASIC VALIDATION
  # ============================================================================
  
  validation:
    name: ğŸ” Basic Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: ğŸ” Python Syntax Check
        run: |
          python -m py_compile main.py
          echo "âœ… Main application syntax OK"
      
      - name: ğŸ§ª Import Test
        run: |
          python -c "import main; print('âœ… Main application imports successfully')"
      
      - name: ğŸ“‹ Test Discovery
        run: |
          python -m pytest --collect-only -q | head -10
          echo "âœ… Test discovery successful"

  # ============================================================================
  # CORE TESTS
  # ============================================================================
  
  core-tests:
    name: ğŸ§ª Core Tests
    runs-on: ubuntu-latest
    needs: validation
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: ğŸ§ª Run Core Tests
        run: |
          pytest tests/test_main.py tests/test_basic_functionality.py -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=30 \
            --tb=short \
            --maxfail=10
      
      - name: ğŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: core
          name: core-coverage

  # ============================================================================
  # API TESTS
  # ============================================================================
  
  api-tests:
    name: ğŸŒ API Tests
    runs-on: ubuntu-latest
    needs: validation
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: ğŸ§ª Run API Tests
        run: |
          pytest tests/api/ -v \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=xml:coverage-api.xml \
            --cov-fail-under=30 \
            --tb=short \
            --maxfail=5
      
      - name: ğŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage-api.xml
          flags: api
          name: api-coverage

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================
  
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [core-tests, api-tests]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: ğŸ§ª Run Integration Tests
        run: |
          pytest tests/integration/ tests/security/ -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage-integration.xml \
            --cov-fail-under=20 \
            --tb=short \
            --maxfail=5
      
      - name: ğŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage-integration.xml
          flags: integration
          name: integration-coverage

  # ============================================================================
  # DEPLOYMENT READINESS
  # ============================================================================
  
  deployment-check:
    name: ğŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [core-tests, api-tests, integration-tests]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ—ï¸ Build Check
        run: |
          python -c "
          import main
          app = main.app
          print(f'âœ… App Title: {app.title}')
          print(f'âœ… App Version: {app.version}')
          print('âœ… Application builds successfully')
          "
      
      - name: ğŸ¯ Final Status
        run: |
          echo "ğŸ‰ ALL CHECKS PASSED - READY FOR DEPLOYMENT!"
          echo "âœ… Syntax validation: PASSED"
          echo "âœ… Import tests: PASSED"
          echo "âœ… Core tests: PASSED"
          echo "âœ… API tests: PASSED"
          echo "âœ… Integration tests: PASSED"
          echo "âœ… Build check: PASSED"
          echo ""
          echo "ğŸš€ DevSkyy Platform is production-ready!"

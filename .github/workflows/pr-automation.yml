# DevSkyy PR Automation
# Auto-labeling, size checks, review assignment
name: üîÑ PR Automation

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label-pr:
    name: üè∑Ô∏è Auto Label
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Label by Files Changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
      
      - name: Label by Size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false

  lint-pr:
    name: üé® PR Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install linters
        run: pip install ruff black
      
      - name: Check formatting
        run: |
          black --check --diff . || echo "::warning::Code formatting issues found"
      
      - name: Lint code
        run: |
          ruff check . --output-format=github || echo "::warning::Linting issues found"

  test-pr:
    name: üß™ PR Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.vercel.txt
          pip install pytest pytest-cov httpx pytest-asyncio
      
      - name: Run tests
        run: pytest tests/ -v --tb=short || true
      
      - name: Comment test results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Tests completed! Check the Actions tab for details.'
            })

  pr-checklist:
    name: ‚úÖ PR Checklist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            const checks = [];
            
            // Check for description
            if (body.length < 50) {
              checks.push('‚ö†Ô∏è PR description is too short (< 50 chars)');
            } else {
              checks.push('‚úÖ PR has adequate description');
            }
            
            // Check for linked issues
            if (body.match(/#\d+/) || body.match(/closes/i) || body.match(/fixes/i)) {
              checks.push('‚úÖ PR references an issue');
            } else {
              checks.push('‚ö†Ô∏è Consider linking to a related issue');
            }
            
            // Check title format
            const titlePattern = /^(feat|fix|docs|style|refactor|test|chore|ci)(\(.+\))?:/;
            if (titlePattern.test(pr.title)) {
              checks.push('‚úÖ PR title follows conventional commits');
            } else {
              checks.push('‚ö†Ô∏è Consider using conventional commit format');
            }
            
            const summary = checks.join('\n');
            
            core.summary
              .addHeading('PR Quality Checklist')
              .addRaw(summary)
              .write();

  auto-assign:
    name: üë§ Auto Assign
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - uses: kentaro-m/auto-assign-action@v2.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: '.github/auto-assign.yml'

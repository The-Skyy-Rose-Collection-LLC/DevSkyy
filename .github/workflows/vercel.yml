name: Vercel Deployment & Testing

on:
  push:
    branches: ['**']
    paths:
      - 'vercel/**'
      - 'vercel.json'
      - 'vercel_startup.py'
      - '.vercelignore'
      - '.github/workflows/vercel.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'vercel/**'
      - 'vercel.json'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11.9'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================================================
  # JOB 1: Vercel Dependency Check
  # ============================================================================
  vercel-dependency-check:
    name: Vercel Dependency Isolation Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check Vercel dependencies isolation
        run: |
          echo "Checking vercel/requirements.txt for serverless optimization..."
          
          # Check that heavy ML dependencies are NOT in vercel requirements
          if grep -E "(torch|tensorflow|transformers)" vercel/requirements.txt; then
            echo "ERROR: Heavy ML dependencies found in vercel/requirements.txt"
            echo "These will cause slow cold starts and exceed serverless size limits"
            exit 1
          fi
          
          # Check that core dependencies ARE present
          if ! grep -E "(fastapi|uvicorn|pydantic)" vercel/requirements.txt; then
            echo "ERROR: Core dependencies missing from vercel/requirements.txt"
            exit 1
          fi
          
          echo "‚úì Vercel dependencies are properly isolated"

      - name: Validate bundle size
        run: |
          pip install pip-tools
          pip-compile --dry-run --no-header vercel/requirements.txt || exit 1
          
          # Estimate bundle size (rough calculation)
          echo "Checking estimated bundle size..."
          pip download -r vercel/requirements.txt -d /tmp/vercel-deps --no-deps
          du -sh /tmp/vercel-deps || true
          
          echo "‚úì Vercel requirements file is valid"

  # ============================================================================
  # JOB 2: Vercel Configuration Validation
  # ============================================================================
  vercel-config-validation:
    name: Vercel Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate vercel.json
        run: |
          # Check if vercel.json exists and is valid JSON
          if [ -f "vercel.json" ]; then
            python -c "
            import json
            with open('vercel.json') as f:
                config = json.load(f)
            
            print('‚úì vercel.json is valid JSON')
            print(f'Framework: {config.get(\"framework\", \"not set\")}')
            print(f'Build command: {config.get(\"buildCommand\", \"not set\")}')
            
            # Check for isolated requirements reference
            build_cmd = config.get('buildCommand', '')
            if 'vercel/requirements.txt' in build_cmd:
                print('‚úì Using isolated vercel/requirements.txt')
            else:
                print('‚ö† Not using isolated requirements')
            "
          else
            echo "ERROR: vercel.json not found"
            exit 1
          fi

      - name: Validate .vercelignore
        run: |
          if [ -f ".vercelignore" ]; then
            echo "‚úì .vercelignore found"
            cat .vercelignore
          else
            echo "‚ö† .vercelignore not found, deployment may include unnecessary files"
          fi

  # ============================================================================
  # JOB 3: Serverless Build Test
  # ============================================================================
  serverless-build-test:
    name: Serverless Build Test
    runs-on: ubuntu-latest
    needs: vercel-dependency-check
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Vercel dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r vercel/requirements.txt

      - name: Test serverless imports
        run: |
          python -c "
          import sys
          import time
          
          # Measure cold start time
          start = time.time()
          
          # Import critical dependencies
          import fastapi
          import uvicorn
          import pydantic
          import sqlalchemy
          
          end = time.time()
          import_time = end - start
          
          print(f'‚úì All serverless libraries imported successfully')
          print(f'Import time (cold start simulation): {import_time:.3f}s')
          
          # Check versions
          print(f'FastAPI: {fastapi.__version__}')
          print(f'Pydantic: {pydantic.__version__}')
          print(f'SQLAlchemy: {sqlalchemy.__version__}')
          
          # Warn if cold start is too slow
          if import_time > 5.0:
              print('‚ö† Cold start time is high (>5s)')
              sys.exit(1)
          "

      - name: Test FastAPI application startup
        run: |
          # Test that the main app can be imported
          if [ -f "main.py" ]; then
            python -c "
            import sys
            sys.path.insert(0, '.')
            
            try:
                from main import app
                print('‚úì FastAPI app imported successfully')
            except Exception as e:
                print(f'‚ö† App import: {e}')
            "
          fi

  # ============================================================================
  # JOB 4: Vercel CLI Build Test
  # ============================================================================
  vercel-cli-build:
    name: Vercel CLI Build Test
    runs-on: ubuntu-latest
    needs: vercel-config-validation
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        run: |
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }} || true

      - name: Build Project
        run: |
          # Test build locally
          vercel build || echo "‚ö† Vercel build failed (expected if not configured)"

  # ============================================================================
  # JOB 5: Preview Deployment
  # ============================================================================
  vercel-preview-deploy:
    name: Vercel Preview Deployment
    runs-on: ubuntu-latest
    needs: [vercel-dependency-check, serverless-build-test]
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        run: |
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Preview
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        id: deploy
        run: |
          vercel deploy --token=${{ secrets.VERCEL_TOKEN }} > deployment-url.txt
          echo "deployment_url=$(cat deployment-url.txt)" >> $GITHUB_OUTPUT

      - name: Comment deployment URL
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.deployment_url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Preview deployment ready!\n\n${url}`
            });

  # ============================================================================
  # JOB 6: Production Deployment
  # ============================================================================
  vercel-production-deploy:
    name: Vercel Production Deployment
    runs-on: ubuntu-latest
    needs: [vercel-dependency-check, serverless-build-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        run: |
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Production
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        id: deploy
        run: |
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} > deployment-url.txt
          echo "deployment_url=$(cat deployment-url.txt)" >> $GITHUB_OUTPUT

      - name: Production deployment notification
        if: env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        run: |
          echo "‚úÖ Production deployment successful!"
          echo "URL: ${{ steps.deploy.outputs.deployment_url }}"

  # ============================================================================
  # JOB 7: Deployment Health Check
  # ============================================================================
  deployment-health-check:
    name: Deployment Health Check
    runs-on: ubuntu-latest
    needs: vercel-preview-deploy
    if: github.event_name == 'pull_request' && needs.vercel-preview-deploy.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check deployment health
        run: |
          # This would check the health endpoint of the deployed app
          echo "Health check would run here"
          # curl -f https://your-deployment-url/health || exit 1

  # ============================================================================
  # JOB 8: Performance Testing
  # ============================================================================
  vercel-performance-test:
    name: Serverless Performance Test
    runs-on: ubuntu-latest
    needs: serverless-build-test
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r vercel/requirements.txt

      - name: Measure cold start time
        run: |
          python -c "
          import time
          import sys
          
          # Simulate cold start
          iterations = 5
          times = []
          
          for i in range(iterations):
              # Clear import cache
              if i > 0:
                  for module in list(sys.modules.keys()):
                      if 'fastapi' in module or 'pydantic' in module:
                          del sys.modules[module]
              
              start = time.time()
              import fastapi
              import pydantic
              import sqlalchemy
              end = time.time()
              
              times.append(end - start)
              print(f'Iteration {i+1}: {end - start:.3f}s')
          
          avg_time = sum(times) / len(times)
          print(f'\nAverage cold start: {avg_time:.3f}s')
          
          # Warn if average is too high
          if avg_time > 3.0:
              print('‚ö† Average cold start time is high')
          else:
              print('‚úì Cold start time is acceptable')
          "

  # ============================================================================
  # Summary Job
  # ============================================================================
  vercel-summary:
    name: Vercel Workflow Summary
    runs-on: ubuntu-latest
    needs: [vercel-dependency-check, vercel-config-validation, serverless-build-test, vercel-performance-test]
    if: always()

    steps:
      - name: Check workflow status
        run: |
          echo "Vercel Workflow Summary:"
          echo "‚úì Dependency Check: ${{ needs.vercel-dependency-check.result }}"
          echo "‚úì Config Validation: ${{ needs.vercel-config-validation.result }}"
          echo "‚úì Build Test: ${{ needs.serverless-build-test.result }}"
          echo "‚úì Performance Test: ${{ needs.vercel-performance-test.result }}"
          
          if [ "${{ needs.vercel-dependency-check.result }}" != "success" ] || \
             [ "${{ needs.vercel-config-validation.result }}" != "success" ] || \
             [ "${{ needs.serverless-build-test.result }}" != "success" ] || \
             [ "${{ needs.vercel-performance-test.result }}" != "success" ]; then
            echo "‚ùå Some Vercel checks failed"
            exit 1
          fi
          
          echo "‚úÖ All Vercel checks passed"

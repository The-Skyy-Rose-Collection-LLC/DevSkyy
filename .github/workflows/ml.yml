name: ML Environment CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ml/**'
      - 'agents/**'
      - 'orchestration/**'
      - '.github/workflows/ml.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ml/**'
      - 'agents/**'
      - 'orchestration/**'

jobs:
  ml-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache ML dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-ml-pip-${{ hashFiles('ml/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-ml-pip-

    - name: Install ML dependencies
      run: |
        cd ml
        pip install -r requirements.txt

    - name: Run ML-specific tests
      run: |
        pytest tests/ -k "ml or agent or model" -v --tb=short

    - name: Test model loading
      run: |
        python -c "
        try:
            import torch
            import transformers
            print('✅ ML dependencies loaded successfully')
        except ImportError as e:
            print(f'❌ ML dependency error: {e}')
            exit(1)
        "

    - name: Run agent tests
      run: |
        pytest tests/test_agents.py -v

    - name: Test orchestration
      run: |
        pytest tests/ -k "orchestration" -v

  ml-model-validation:
    runs-on: ubuntu-latest
    needs: ml-test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install ML dependencies
      run: |
        cd ml
        pip install -r requirements.txt

    - name: Validate model configurations
      run: |
        python -c "
        from agents.fashn_agent import FashnAgent
        from agents.tripo_agent import TripoAgent
        print('✅ Agent configurations valid')
        "

    - name: Test model inference
      run: |
        python -c "
        # Test basic model functionality
        import torch
        if torch.cuda.is_available():
            print(f'✅ CUDA available: {torch.cuda.get_device_name(0)}')
        else:
            print('ℹ️ CUDA not available, using CPU')
        "

  ml-performance:
    runs-on: ubuntu-latest
    needs: ml-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install ML dependencies
      run: |
        cd ml
        pip install -r requirements.txt

    - name: Run performance benchmarks
      run: |
        python -c "
        import time
        import torch

        # Basic performance test
        start_time = time.time()

        # Test tensor operations
        x = torch.randn(1000, 1000)
        y = torch.randn(1000, 1000)
        z = torch.matmul(x, y)

        end_time = time.time()
        duration = end_time - start_time

        print(f'✅ Matrix multiplication (1000x1000): {duration:.3f}s')

        if duration > 5.0:
            print('⚠️ Performance warning: Operation took longer than expected')
        "

  ml-security:
    runs-on: ubuntu-latest
    needs: ml-test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        pip install bandit safety

    - name: Run ML security scan
      run: |
        bandit -r ml/ agents/ orchestration/ -f json -o ml-security-report.json || true
        safety check --json --output ml-safety-report.json || true

    - name: Upload security reports
      uses: actions/upload-artifact@v6
      with:
        name: ml-security-reports
        path: |
          ml-security-report.json
          ml-safety-report.json

  ml-documentation:
    runs-on: ubuntu-latest
    needs: ml-test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install documentation dependencies
      run: |
        pip install sphinx sphinx-rtd-theme

    - name: Generate ML documentation
      run: |
        # Generate API documentation for ML components
        sphinx-apidoc -o docs/ml/ agents/ orchestration/
        echo "✅ ML documentation generated"

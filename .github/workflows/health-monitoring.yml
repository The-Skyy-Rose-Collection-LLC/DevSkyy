# DevSkyy Health Monitoring
# Scheduled uptime checks, API validation, performance monitoring
name: ðŸ¥ Health Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

env:
  PRODUCTION_URL: https://devskyy-skkyroseco.vercel.app

jobs:
  health-check:
    name: ðŸ©º Health Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the workflow if checks fail
    steps:
      - name: Check /health endpoint
        id: health
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" --connect-timeout 10 --max-time 30 ${{ env.PRODUCTION_URL }}/health || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" = "000" ]; then
            echo "::warning::Health check failed - site unreachable"
          elif [ "$HTTP_CODE" != "200" ]; then
            echo "::warning::Health check returned status $HTTP_CODE"
          else
            echo "âœ… Health check passed"
          fi

      - name: Check /docs endpoint
        continue-on-error: true
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 ${{ env.PRODUCTION_URL }}/docs || echo "000")
          if [ "$HTTP_CODE" = "000" ]; then
            echo "::warning::Docs endpoint unreachable"
          elif [ "$HTTP_CODE" != "200" ]; then
            echo "::warning::Docs endpoint returned $HTTP_CODE"
          else
            echo "âœ… Docs endpoint OK"
          fi

      - name: Check API endpoints
        continue-on-error: true
        run: |
          ENDPOINTS=(
            "/api/v1/agents"
            "/api/v1/3d/status"
            "/api/v1/ecommerce/status"
            "/api/v1/metrics"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "${{ env.PRODUCTION_URL }}$endpoint" || echo "000")
            if [ "$HTTP_CODE" = "000" ]; then
              echo "::warning::$endpoint unreachable"
            elif [ "$HTTP_CODE" != "200" ]; then
              echo "::warning::$endpoint returned $HTTP_CODE"
            else
              echo "âœ… $endpoint OK"
            fi
          done

      - name: Measure Response Time
        continue-on-error: true
        run: |
          TIME=$(curl -s -o /dev/null -w "%{time_total}" --connect-timeout 10 --max-time 30 ${{ env.PRODUCTION_URL }}/health 2>/dev/null || echo "0")
          if [ "$TIME" = "0" ]; then
            echo "::warning::Could not measure response time - site may be down"
          else
            echo "Response time: ${TIME}s"
            # Alert if response > 2 seconds
            if (( $(echo "$TIME > 2" | bc -l) )); then
              echo "::warning::Response time ${TIME}s exceeds 2s threshold"
            fi
          fi

  ssl-check:
    name: ðŸ” SSL Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check SSL Certificate
        continue-on-error: true
        run: |
          DOMAIN=$(echo ${{ env.PRODUCTION_URL }} | sed 's|https://||' | sed 's|/.*||')
          
          # Get certificate expiry
          EXPIRY=$(echo | openssl s_client -servername "$DOMAIN" -connect "$DOMAIN:443" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
          
          if [ -z "$EXPIRY" ]; then
            echo "::warning::Could not check SSL certificate - site may not be deployed"
            exit 0
          fi
          
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null || echo "0")
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))
          
          echo "SSL Certificate expires: $EXPIRY"
          echo "Days until expiry: $DAYS_LEFT"
          
          if [ "$DAYS_LEFT" -lt 30 ]; then
            echo "::warning::SSL certificate expires in $DAYS_LEFT days!"
          else
            echo "âœ… SSL certificate valid for $DAYS_LEFT days"
          fi

  report:
    name: ðŸ“Š Report
    runs-on: ubuntu-latest
    needs: [health-check, ssl-check]
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸ¥ Health Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SSL Check | ${{ needs.ssl-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ env.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

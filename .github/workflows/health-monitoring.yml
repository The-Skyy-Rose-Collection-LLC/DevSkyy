# DevSkyy Health Monitoring
# Scheduled uptime checks, API validation, performance monitoring
name: ðŸ¥ Health Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

env:
  PRODUCTION_URL: https://devskyy-skkyroseco.vercel.app

jobs:
  health-check:
    name: ðŸ©º Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Check /health endpoint
        id: health
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" ${{ env.PRODUCTION_URL }}/health)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Health check failed with status $HTTP_CODE"
            exit 1
          fi
          
          echo "âœ… Health check passed"

      - name: Check /docs endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/docs)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::warning::Docs endpoint returned $HTTP_CODE"
          fi

      - name: Check API endpoints
        run: |
          ENDPOINTS=(
            "/api/v1/agents"
            "/api/v1/3d/status"
            "/api/v1/ecommerce/status"
            "/api/v1/metrics"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.PRODUCTION_URL }}$endpoint")
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::warning::$endpoint returned $HTTP_CODE"
            else
              echo "âœ… $endpoint OK"
            fi
          done

      - name: Measure Response Time
        run: |
          TIME=$(curl -s -o /dev/null -w "%{time_total}" ${{ env.PRODUCTION_URL }}/health)
          echo "Response time: ${TIME}s"
          
          # Alert if response time > 2 seconds
          if (( $(echo "$TIME > 2.0" | bc -l) )); then
            echo "::warning::Slow response time: ${TIME}s"
          fi

  ssl-check:
    name: ðŸ” SSL Check
    runs-on: ubuntu-latest
    steps:
      - name: Check SSL Certificate
        run: |
          DOMAIN="devskyy-skkyroseco.vercel.app"
          EXPIRY=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2)
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
          
          echo "SSL Certificate expires in $DAYS_LEFT days"
          
          if [ $DAYS_LEFT -lt 30 ]; then
            echo "::warning::SSL certificate expires in $DAYS_LEFT days"
          fi

  report:
    name: ðŸ“Š Report
    runs-on: ubuntu-latest
    needs: [health-check, ssl-check]
    if: always()
    steps:
      - name: Create Report
        run: |
          echo "## ðŸ¥ Health Report - $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SSL Check | ${{ needs.ssl-check.result }} |" >> $GITHUB_STEP_SUMMARY

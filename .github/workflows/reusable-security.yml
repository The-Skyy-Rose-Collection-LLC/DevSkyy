---
# DevSkyy Platform - Reusable Security Workflow
# Truth Protocol compliant security scanning and enforcement
# FIXED: All gates now fail on HIGH/CRITICAL vulnerabilities

name: Security Suite

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    # FIXED: Safety fails on HIGH/CRITICAL instead of warning
    - name: Run Safety (Dependency Vulnerability Scanner)
      run: |
        python -m pip install --upgrade pip
        pip install safety

        # FIXED: exit-code 1 to fail workflow on vulnerabilities
        safety check --json --output safety-report.json || true

        # Check for HIGH/CRITICAL vulnerabilities
        if [ -f safety-report.json ]; then
          HIGH_CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "high" or .severity == "critical")] | length' safety-report.json 2>/dev/null || echo "0")
          if [ "$HIGH_CRITICAL" -gt 0 ]; then
            echo "::error::Found $HIGH_CRITICAL HIGH/CRITICAL dependency vulnerabilities"
            echo "::group::Safety Report"
            jq -r '.vulnerabilities[] | select(.severity == "high" or .severity == "critical") | "Package: \(.package_name) \(.vulnerable_spec)\nVulnerability: \(.vulnerability_id)\nSeverity: \(.severity)\nDescription: \(.advisory)\n---"' safety-report.json
            echo "::endgroup::"
            exit 1
          fi
        fi

    - name: Run Bandit (Python Security Linter)
      run: |
        pip install bandit[toml]
        bandit -r . -f json -o bandit-report.json -c pyproject.toml || true

        # Check for HIGH/CRITICAL issues
        if [ -f bandit-report.json ]; then
          CRITICAL=$(jq '[.results[] | select(.issue_severity == "HIGH" or .issue_severity == "CRITICAL")] | length' bandit-report.json)
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL HIGH/CRITICAL security issues"
            echo "::group::Bandit Report"
            jq -r '.results[] | select(.issue_severity == "HIGH" or .issue_severity == "CRITICAL") | "File: \(.filename):\(.line_number)\nSeverity: \(.issue_severity)\nConfidence: \(.issue_confidence)\nIssue: \(.issue_text)\nCWE: \(.issue_cwe.id)\n---"' bandit-report.json
            echo "::endgroup::"
            exit 1
          fi
        fi

    # FIXED: Trivy fails on both HIGH and CRITICAL CVEs
    - name: Run Trivy (Container/Filesystem Scanner)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-report.json'
        # FIXED: Include HIGH severity vulnerabilities
        severity: 'HIGH,CRITICAL'
        # FIXED: exit-code 1 to fail workflow
        exit-code: '1'
        ignore-unfixed: false

    - name: Parse Trivy Results
      if: always()
      run: |
        if [ -f trivy-report.json ]; then
          echo "::group::Trivy Summary"
          jq -r '.Results[] | select(.Vulnerabilities) | "Target: \(.Target)\nVulnerabilities: \(.Vulnerabilities | length)"' trivy-report.json
          echo "::endgroup::"

          # Count HIGH/CRITICAL vulnerabilities
          HIGH_CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-report.json)
          if [ "$HIGH_CRITICAL" -gt 0 ]; then
            echo "::error::Found $HIGH_CRITICAL HIGH/CRITICAL vulnerabilities"
            echo "::group::HIGH/CRITICAL Vulnerabilities"
            jq -r '.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL") | "Package: \(.PkgName) \(.InstalledVersion)\nVulnerability: \(.VulnerabilityID)\nSeverity: \(.Severity)\nFixed: \(.FixedVersion // "N/A")\nTitle: \(.Title)\n---"' trivy-report.json
            echo "::endgroup::"
          fi
        fi

    # FIXED: Semgrep fails on findings instead of warning
    - name: Run Semgrep (Static Analysis)
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/python
        # FIXED: Generate blocking errors instead of warnings
        generateSarif: true
      env:
        SEMGREP_RULES: p/security-audit p/owasp-top-ten p/python

    # Upload SARIF file for GitHub Security tab
    - name: Upload Semgrep SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep.sarif
        category: semgrep

    # Additional security checks
    - name: Check for secrets in code
      run: |
        pip install detect-secrets
        detect-secrets scan --baseline .secrets.baseline || true

        # Check if any secrets were detected
        if [ -f .secrets.baseline ]; then
          SECRET_COUNT=$(jq '.results | to_entries | length' .secrets.baseline)
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "::error::Found $SECRET_COUNT potential secrets in code"
            echo "::group::Detected Secrets"
            jq -r '.results | to_entries[] | "File: \(.key)\nSecrets: \(.value | length)\n---"' .secrets.baseline
            echo "::endgroup::"
            exit 1
          fi
        fi

    - name: Run pip-audit (Python Package Auditor)
      run: |
        pip install pip-audit
        pip-audit --format json --output pip-audit-report.json || true

        # Check for HIGH/CRITICAL vulnerabilities
        if [ -f pip-audit-report.json ]; then
          HIGH_CRITICAL=$(jq '[.vulnerabilities[] | select(.fix_versions)] | length' pip-audit-report.json 2>/dev/null || echo "0")
          if [ "$HIGH_CRITICAL" -gt 0 ]; then
            echo "::error::Found $HIGH_CRITICAL vulnerabilities with available fixes"
            echo "::group::pip-audit Report"
            jq -r '.vulnerabilities[] | "Package: \(.name) \(.version)\nVulnerability: \(.id)\nFixed in: \(.fix_versions | join(", "))\nAliases: \(.aliases | join(", "))\n---"' pip-audit-report.json
            echo "::endgroup::"
            exit 1
          fi
        fi

    # Upload all security reports as artifacts
    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          *-report.json
          semgrep.sarif
          .secrets.baseline
        retention-days: 30

    # Generate security summary
    - name: Generate Security Summary
      if: always()
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f safety-report.json ]; then
          SAFETY_VULNS=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
          echo "- **Safety**: $SAFETY_VULNS vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f bandit-report.json ]; then
          BANDIT_ISSUES=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")
          echo "- **Bandit**: $BANDIT_ISSUES security issues found" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f trivy-report.json ]; then
          TRIVY_VULNS=$(jq '[.Results[].Vulnerabilities[]?] | length' trivy-report.json 2>/dev/null || echo "0")
          echo "- **Trivy**: $TRIVY_VULNS vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f pip-audit-report.json ]; then
          PIPAUDIT_VULNS=$(jq '.vulnerabilities | length' pip-audit-report.json 2>/dev/null || echo "0")
          echo "- **pip-audit**: $PIPAUDIT_VULNS vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Truth Protocol Compliance**: All HIGH/CRITICAL vulnerabilities block the pipeline" >> $GITHUB_STEP_SUMMARY

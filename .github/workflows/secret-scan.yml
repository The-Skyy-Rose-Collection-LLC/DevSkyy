# --- START FILE: .github/workflows/secret-scan.yml ---
name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
  schedule:
    - cron: "0 4 * * *"  # Daily at 4 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  secret-scan:
    name: GitGuardian Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # SECURITY: SHA-pinned to v4.2.2 (2024-11-20)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
          persist-credentials: false

      # GitGuardian secret scanning
      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@3c5b1b137e5606a4c0c7407fcf9b6c03bda8e58b  # v1.33.0
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # SECURITY: SHA-pinned to v4.2.2 (2024-11-20)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      # Gitleaks secret scanning (open-source alternative)
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@cb7149a9   # v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  trufflehog-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # SECURITY: SHA-pinned to v4.2.2 (2024-11-20)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      # TruffleHog secret scanning
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@4ef8fb5ef4ada14e4208605c83ce4b5a4c8570da  # v3.87.2
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  detect-secrets-scan:
    name: Detect Secrets Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # SECURITY: SHA-pinned to v4.2.2 (2024-11-20)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          persist-credentials: false

      # SECURITY: SHA-pinned to v5.3.0 (2024-10-28)
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a20
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: |
          pip install detect-secrets==1.5.0

      - name: Run detect-secrets scan
        run: |
          # Create baseline if doesn't exist
          if [ ! -f .secrets.baseline ]; then
            detect-secrets scan --baseline .secrets.baseline
          fi

          # Scan for new secrets
          detect-secrets scan --baseline .secrets.baseline --fail-on-unaudited-potential-secret

          # Compare against baseline
          git ls-files -z | xargs -0 detect-secrets-hook --baseline .secrets.baseline

      - name: Upload secrets baseline
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: secrets-baseline
          path: .secrets.baseline
          retention-days: 90

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, gitleaks-scan, trufflehog-scan, detect-secrets-scan]
    if: always()

    steps:
      - name: Generate Security Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ” Secret Scanning Results

          | Scanner | Status |
          |---------|--------|
          | GitGuardian | ${{ needs.secret-scan.result }} |
          | Gitleaks | ${{ needs.gitleaks-scan.result }} |
          | TruffleHog | ${{ needs.trufflehog-scan.result }} |
          | detect-secrets | ${{ needs.detect-secrets-scan.result }} |

          ### Security Recommendations

          âœ… Rotate any exposed secrets immediately
          âœ… Use GitHub Secrets for sensitive data
          âœ… Enable secret scanning in repository settings
          âœ… Review .gitignore for sensitive file patterns
          âœ… Use pre-commit hooks for local scanning

          EOF
# --- END FILE ---

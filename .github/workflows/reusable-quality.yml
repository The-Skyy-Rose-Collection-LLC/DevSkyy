# --- START FILE: .github/workflows/reusable-quality.yml ---
name: Reusable Quality Suite

on:
  workflow_call:

permissions:
  contents: read

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # SECURITY: SHA-pinned to v4.2.2 (2024-11-20)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          persist-credentials: false

      # SECURITY: SHA-pinned to v5.3.0 (2024-10-28)
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a20
        with:
          python-version: '3.11'

      - name: Install code quality tools
        run: |
          pip install --upgrade "pip>=25.3,<26.0" "setuptools>=78.1.1,<79.0.0"
          pip install \
            ruff==0.8.4 \
            black==24.10.0 \
            isort==5.13.2 \
            flake8==7.1.1 \
            mypy==1.14.0 \
            jsonschema==4.23.0 \
            pyyaml==6.0.2

      - name: Ruff - Fast Python Linter
        run: |
          echo "Running Ruff linter..."
          echo "This check will FAIL the build if issues are found"
          ruff check . --output-format=github

      - name: Black - Code Formatter Check
        run: |
          echo "Checking code formatting with Black..."
          echo "This check will FAIL the build if formatting issues are found"
          black --check --diff .

      - name: isort - Import Order Check
        run: |
          echo "Checking import order with isort..."
          echo "This check will FAIL the build if import order issues are found"
          isort --check-only --diff .

      - name: Flake8 - PEP8 Compliance
        run: |
          echo "Running Flake8 PEP8 checker..."
          echo "This check will FAIL the build if PEP8 violations are found"
          flake8 . --exclude=migrations,venv,node_modules --statistics

      - name: mypy - Static Type Checking
        run: |
          echo "Running mypy static type checker..."
          echo "This check will WARN but not fail the build (type checking is advisory)"
          mypy . --ignore-missing-imports --no-strict-optional || echo "::warning::mypy found type issues"
        continue-on-error: true

      - name: Validate OpenAPI schema (if exists)
        run: |
          if [ -f openapi.yml ] || [ -f openapi.yaml ] || [ -f openapi.json ]; then
            echo "Validating OpenAPI schema..."
            python -m jsonschema validate --instance openapi.yml || true
          else
            echo "No OpenAPI schema found, skipping validation"
          fi

      - name: Generate quality report
        if: always()
        run: |
          mkdir -p quality-reports
          cat > quality-reports/quality-summary.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "checks": {
              "ruff": "completed (blocking)",
              "black": "completed (blocking)",
              "isort": "completed (blocking)",
              "flake8": "completed (blocking)",
              "mypy": "completed (advisory)"
            },
            "enforcement": {
              "ruff": "FAIL on errors",
              "black": "FAIL on formatting issues",
              "isort": "FAIL on import order issues",
              "flake8": "FAIL on PEP8 violations",
              "mypy": "WARNING only (advisory)"
            }
          }
          EOF

      # SECURITY: SHA-pinned to v4.6.2 (2024-11-12)
      - name: Upload quality reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: quality-reports
          path: quality-reports/
          retention-days: 30
# --- END FILE ---

---
# DevSkyy Platform - Reusable Code Quality Workflow
# Truth Protocol compliant linting, formatting, and validation
# FIXED: OpenAPI schema validation with proper jsonschema command

name: Code Quality

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'

permissions:
  contents: read
  actions: write

jobs:
  lint-and-format:
    name: Lint and Format
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade "pip>=25.3,<26.0" "setuptools>=78.1.1,<79.0.0"
        pip install ruff black mypy isort

    - name: Run Ruff (Linter)
      run: |
        ruff check . --output-format=github --exit-non-zero-on-fix

    - name: Run Black (Formatter Check)
      run: |
        black --check --diff .

    - name: Run isort (Import Sorter Check)
      run: |
        isort --check-only --diff .

    - name: Run Mypy (Type Checker)
      run: |
        mypy . --show-error-codes --pretty || true

  openapi-validation:
    name: OpenAPI Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade "pip>=25.3,<26.0" "setuptools>=78.1.1,<79.0.0"
        pip install openapi-spec-validator jsonschema pyyaml

    # FIXED: Proper jsonschema validation command with schema file
    - name: Validate OpenAPI Schema
      run: |
        # Generate OpenAPI schema from FastAPI app
        python -c "
        from main import app
        import json
        with open('openapi.json', 'w') as f:
            json.dump(app.openapi(), f, indent=2)
        "

        # Validate OpenAPI spec
        openapi-spec-validator openapi.json

        # Additional validation with jsonschema
        # FIXED: Using check-jsonschema for proper validation
        pip install check-jsonschema
        check-jsonschema --schemafile https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/schemas/v3.0/schema.json openapi.json

    - name: Upload OpenAPI Schema
      uses: actions/upload-artifact@v4
      with:
        name: openapi-schema
        path: openapi.json
        retention-days: 30

  dependency-check:
    name: Dependency Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Check for outdated packages
      run: |
        python -m pip install --upgrade pip
        pip list --outdated --format=json > outdated-packages.json || true

        if [ -f outdated-packages.json ]; then
          OUTDATED_COUNT=$(jq 'length' outdated-packages.json)
          echo "Found $OUTDATED_COUNT outdated packages"

          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "::warning::Found $OUTDATED_COUNT outdated packages"
            echo "::group::Outdated Packages"
            jq -r '.[] | "Package: \(.name) \(.version) -> \(.latest_version)"' outdated-packages.json
            echo "::endgroup::"
          fi
        fi

    - name: Check dependency tree
      run: |
        pip install pipdeptree
        pipdeptree --json > dependency-tree.json
        pipdeptree --warn fail

    - name: Upload dependency reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          outdated-packages.json
          dependency-tree.json
        retention-days: 7

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for required documentation
      run: |
        REQUIRED_DOCS=(
          "README.md"
          "CHANGELOG.md"
          "CLAUDE.md"
          "docs/API.md"
          "docs/DEPLOYMENT.md"
        )

        MISSING_DOCS=()
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ ! -f "$doc" ]; then
            MISSING_DOCS+=("$doc")
          fi
        done

        if [ ${#MISSING_DOCS[@]} -gt 0 ]; then
          echo "::warning::Missing required documentation files:"
          printf '%s\n' "${MISSING_DOCS[@]}"
        fi

    - name: Check markdown formatting
      uses: DavidAnson/markdownlint-cli2-action@v15
      with:
        globs: |
          **/*.md
          !node_modules
          !.venv

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Generate SBOM (CycloneDX)
      run: |
        python -m pip install --upgrade pip
        pip install cyclonedx-bom
        cyclonedx-py requirements \
          --requirements-file requirements.txt \
          --output sbom.json \
          --format json

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.json
        retention-days: 90

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, openapi-validation, dependency-check, documentation-check, sbom-generation]
    if: always()

    steps:
    - name: Generate quality summary
      run: |
        echo "## Code Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All quality checks completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Truth Protocol Compliance**:" >> $GITHUB_STEP_SUMMARY
        echo "- Linting: Ruff" >> $GITHUB_STEP_SUMMARY
        echo "- Formatting: Black + isort" >> $GITHUB_STEP_SUMMARY
        echo "- Type checking: Mypy" >> $GITHUB_STEP_SUMMARY
        echo "- OpenAPI validation: openapi-spec-validator" >> $GITHUB_STEP_SUMMARY
        echo "- SBOM generation: CycloneDX" >> $GITHUB_STEP_SUMMARY

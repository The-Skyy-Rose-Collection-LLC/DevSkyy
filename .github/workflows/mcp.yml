name: MCP Environment CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mcp/**'
      - 'server.py'
      - 'devskyy_mcp.py'
      - 'claude_desktop_config.example.json'
      - '.github/workflows/mcp.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'mcp/**'
      - 'server.py'
      - 'devskyy_mcp.py'
      - 'claude_desktop_config.example.json'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  mcp-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache MCP dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-mcp-pip-${{ hashFiles('mcp/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-mcp-pip-

    - name: Install MCP dependencies
      run: |
        cd mcp
        pip install -r requirements.txt

    - name: Run MCP server tests
      run: |
        python test_server.py

    - name: Test MCP server startup
      run: |
        timeout 10s python server.py || [ $? -eq 124 ]
        echo "✅ MCP server startup test completed"

    - name: Validate MCP configuration
      run: |
        python -c "
        import json
        with open('claude_desktop_config.example.json', 'r') as f:
            config = json.load(f)
        print('✅ MCP configuration valid')
        "

  mcp-integration:
    runs-on: ubuntu-latest
    needs: mcp-test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install MCP dependencies
      run: |
        cd mcp
        pip install -r requirements.txt

    - name: Test OpenAI integration
      if: env.OPENAI_API_KEY != ''
      run: |
        python -c "
        import openai
        from server import handle_completion
        print('✅ OpenAI integration test passed')
        "

    - name: Test MCP tools
      run: |
        python -c "
        from server import TOOLS
        print(f'✅ MCP tools loaded: {len(TOOLS)} tools available')
        for tool_name in TOOLS.keys():
            print(f'  - {tool_name}')
        "

    - name: Test Pydantic models
      run: |
        python -c "
        from server import CompletionRequest, CodeGenerationRequest
        print('✅ Pydantic models validation passed')
        "

  mcp-security:
    runs-on: ubuntu-latest
    needs: mcp-test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        pip install bandit safety

    - name: Run MCP security scan
      run: |
        bandit -r server.py devskyy_mcp.py -f json -o mcp-security-report.json || true
        safety check --json --output mcp-safety-report.json || true

    - name: Check for API key exposure
      run: |
        grep -r "sk-" . --exclude-dir=.git --exclude="*.json" || echo "✅ No API keys found in code"
        grep -r "anthropic" . --exclude-dir=.git --exclude="*.json" | grep -v "ANTHROPIC_API_KEY" || echo "✅ No hardcoded Anthropic keys"

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: mcp-security-reports
        path: |
          mcp-security-report.json
          mcp-safety-report.json

  mcp-performance:
    runs-on: ubuntu-latest
    needs: mcp-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install MCP dependencies
      run: |
        cd mcp
        pip install -r requirements.txt

    - name: Run performance tests
      run: |
        python -c "
        import time
        import asyncio
        from server import handle_completion

        async def test_performance():
            start_time = time.time()

            # Test basic tool loading
            from server import TOOLS
            tool_count = len(TOOLS)

            end_time = time.time()
            duration = end_time - start_time

            print(f'✅ Tool loading performance: {duration:.3f}s for {tool_count} tools')

            if duration > 1.0:
                print('⚠️ Performance warning: Tool loading took longer than expected')

        asyncio.run(test_performance())
        "

  mcp-documentation:
    runs-on: ubuntu-latest
    needs: mcp-test

    steps:
    - uses: actions/checkout@v4

    - name: Validate MCP documentation
      run: |
        # Check that all MCP documentation exists
        files=(
          "docs/guides/SERVER_README.md"
          "docs/guides/QUICKSTART.md"
          "claude_desktop_config.example.json"
        )

        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done

    - name: Test documentation examples
      run: |
        python -c "
        import json

        # Validate Claude Desktop config example
        with open('claude_desktop_config.example.json', 'r') as f:
            config = json.load(f)

        required_keys = ['mcpServers', 'devskyy']
        for key in required_keys:
            if key not in str(config):
                print(f'❌ Missing {key} in config')
                exit(1)

        print('✅ Documentation examples validated')
        "

  mcp-deploy:
    runs-on: ubuntu-latest
    needs: [mcp-integration, mcp-security, mcp-performance]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Deploy MCP server
      run: |
        echo "Deploying MCP server to production environment"
        # Add your MCP deployment commands here
        # Example: Deploy to cloud function or container service

# Falco Runtime Security Rules for DevSkyy
# Reference: https://falco.org/docs/rules/
#
# Deploy with: kubectl apply -f falco-rules.yaml
# Monitor with: kubectl logs -n falco -l app=falco -f

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules
  namespace: falco
  labels:
    app: falco
data:
  devskyy_rules.yaml: |
    # ============================================================================
    # DevSkyy Custom Falco Rules
    # Runtime threat detection for containerized applications
    # ============================================================================

    # Rule: Detect shell spawning in containers
    - rule: Shell Spawned in Container
      desc: Detects when a shell is spawned inside a container (potential breach)
      condition: >
        spawned_process and
        container and
        shell_procs and
        proc.pname exists and
        not proc.pname in (npm, yarn, pm2, node)
      output: >
        Shell spawned in container (user=%user.name user_uid=%user.uid
        command=%proc.cmdline pid=%proc.pid container_id=%container.id
        container_name=%container.name image=%container.image.repository:%container.image.tag)
      priority: WARNING
      tags: [container, shell, mitre_execution]
      source: syscall

    # Rule: Detect unauthorized file access
    - rule: Unauthorized File Access
      desc: Detects access to sensitive files in production containers
      condition: >
        open_read and
        container and
        fd.name in (/etc/shadow, /etc/passwd, /root/.ssh/id_rsa, /root/.aws/credentials) and
        not proc.name in (cat, less, vim, nano)
      output: >
        Unauthorized access to sensitive file (user=%user.name file=%fd.name
        command=%proc.cmdline pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: CRITICAL
      tags: [container, filesystem, mitre_credential_access]
      source: syscall

    # Rule: Detect package manager execution
    - rule: Package Manager Execution in Container
      desc: Detects package manager execution (containers should be immutable)
      condition: >
        spawned_process and
        container and
        proc.name in (apt, apt-get, yum, dnf, apk, pip, npm, yarn) and
        not container.image.repository in (build-container, ci-runner)
      output: >
        Package manager executed in container (user=%user.name command=%proc.cmdline
        pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [container, package_management, mitre_persistence]
      source: syscall

    # Rule: Detect network tool execution
    - rule: Network Tool Execution
      desc: Detects network reconnaissance tools (netcat, nmap, etc.)
      condition: >
        spawned_process and
        container and
        proc.name in (nc, netcat, nmap, tcpdump, wireshark, curl, wget) and
        not user.name in (root, appuser)
      output: >
        Network tool executed (user=%user.name tool=%proc.name command=%proc.cmdline
        pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [network, reconnaissance, mitre_discovery]
      source: syscall

    # Rule: Detect crypto mining
    - rule: Crypto Mining Detection
      desc: Detects cryptocurrency mining activity
      condition: >
        spawned_process and
        container and
        (proc.name in (xmrig, minerd, cpuminer, ethminer, ccminer) or
         proc.cmdline contains "stratum+tcp" or
         proc.cmdline contains "pool.minexmr.com")
      output: >
        CRITICAL: Crypto mining detected (user=%user.name command=%proc.cmdline
        pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: CRITICAL
      tags: [malware, cryptomining, mitre_impact]
      source: syscall

    # Rule: Detect privilege escalation
    - rule: Privilege Escalation Attempt
      desc: Detects attempts to escalate privileges
      condition: >
        spawned_process and
        container and
        proc.name in (sudo, su, setuid, chmod, chown) and
        not user.name = root
      output: >
        Privilege escalation attempt (user=%user.name command=%proc.cmdline
        pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: CRITICAL
      tags: [privilege_escalation, mitre_privilege_escalation]
      source: syscall

    # Rule: Detect reverse shell
    - rule: Reverse Shell Detection
      desc: Detects reverse shell connections
      condition: >
        spawned_process and
        container and
        ((proc.name in (bash, sh, dash, zsh) and
          (proc.cmdline contains "-i" or proc.cmdline contains "/dev/tcp/")) or
         (proc.name in (nc, ncat, netcat) and
          (proc.cmdline contains "-e" or proc.cmdline contains "-c")))
      output: >
        CRITICAL: Reverse shell detected (user=%user.name command=%proc.cmdline
        pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: CRITICAL
      tags: [shell, reverse_shell, mitre_execution]
      source: syscall

    # Rule: Detect suspicious network connections
    - rule: Suspicious Outbound Connection
      desc: Detects connections to suspicious ports (Tor, proxies, etc.)
      condition: >
        outbound and
        container and
        fd.sport in (9050, 9150, 1080, 3128, 8080, 4444, 31337) and
        not fd.sip in (127.0.0.1, ::1)
      output: >
        Suspicious outbound connection (user=%user.name connection=%fd.name
        sport=%fd.sport dport=%fd.dport container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [network, suspicious, mitre_command_and_control]
      source: syscall

    # Rule: Detect container escape attempts
    - rule: Container Escape Attempt
      desc: Detects attempts to escape container isolation
      condition: >
        spawned_process and
        container and
        (proc.cmdline contains "docker" or
         proc.cmdline contains "runc" or
         proc.cmdline contains "kubectl" or
         proc.cmdline contains "ctr" or
         proc.name in (nsenter, unshare, capsh))
      output: >
        CRITICAL: Container escape attempt (user=%user.name command=%proc.cmdline
        pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: CRITICAL
      tags: [container, escape, mitre_privilege_escalation]
      source: syscall

    # Rule: Detect modification of system binaries
    - rule: System Binary Modification
      desc: Detects modification of critical system binaries
      condition: >
        open_write and
        container and
        fd.name pmatch (/bin/*, /sbin/*, /usr/bin/*, /usr/sbin/*) and
        not proc.name in (apt, dpkg, yum, rpm)
      output: >
        System binary modification detected (user=%user.name file=%fd.name
        command=%proc.cmdline pid=%proc.pid container=%container.name)
      priority: CRITICAL
      tags: [filesystem, persistence, mitre_persistence]
      source: syscall

    # Rule: Detect sensitive mount access
    - rule: Sensitive Mount Access
      desc: Detects access to sensitive host mounts
      condition: >
        open_read and
        container and
        fd.name pmatch (/host/*, /proc/*, /sys/*) and
        not proc.name in (ps, top, htop, monitoring-agent)
      output: >
        Access to sensitive mount (user=%user.name file=%fd.name
        command=%proc.cmdline pid=%proc.pid container=%container.name)
      priority: WARNING
      tags: [filesystem, host_access, mitre_discovery]
      source: syscall

    # Rule: Detect log tampering
    - rule: Log File Tampering
      desc: Detects attempts to tamper with log files
      condition: >
        (open_write or remove) and
        container and
        fd.name pmatch (/var/log/*, /app/logs/*) and
        not proc.name in (logrotate, rsyslog, syslog-ng, fluentd, filebeat)
      output: >
        Log file tampering detected (user=%user.name file=%fd.name operation=%evt.type
        command=%proc.cmdline pid=%proc.pid container=%container.name)
      priority: WARNING
      tags: [logs, tampering, mitre_defense_evasion]
      source: syscall

    # Rule: Detect Python/Node process spawning shell
    - rule: Runtime Language Shell Spawn
      desc: Detects when Python/Node spawns a shell (potential code injection)
      condition: >
        spawned_process and
        container and
        shell_procs and
        proc.pname in (python, python3, node, npm, ruby, perl, php) and
        not proc.cmdline contains "manage.py"
      output: >
        Shell spawned by runtime (parent=%proc.pname user=%user.name
        command=%proc.cmdline pid=%proc.pid container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [runtime, code_injection, mitre_execution]
      source: syscall

    # ============================================================================
    # DevSkyy-Specific Rules
    # ============================================================================

    # Rule: Detect unauthorized database access
    - rule: Unauthorized Database Connection
      desc: Detects database connections from unexpected processes
      condition: >
        outbound and
        container and
        fd.sport in (5432, 3306, 27017, 6379) and
        not proc.name in (python, python3, node, uvicorn, gunicorn, celery)
      output: >
        Unauthorized database connection (process=%proc.name user=%user.name
        connection=%fd.name container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [database, unauthorized_access, mitre_credential_access]
      source: syscall

    # Rule: Detect AI/ML model theft attempts
    - rule: Model File Access
      desc: Detects unauthorized access to AI/ML model files
      condition: >
        open_read and
        container and
        fd.name pmatch (*/models/*, *.pkl, *.h5, *.pb, *.onnx, *.pt, *.pth) and
        not proc.name in (python, python3, uvicorn, celery)
      output: >
        Model file accessed (user=%user.name file=%fd.name process=%proc.name
        command=%proc.cmdline container=%container.name)
      priority: CRITICAL
      tags: [ai, model_theft, mitre_exfiltration]
      source: syscall

    # Rule: Detect API key exfiltration attempts
    - rule: Environment Variable Access
      desc: Detects attempts to read environment variables (potential API key theft)
      condition: >
        open_read and
        container and
        fd.name = "/proc/self/environ" and
        not proc.name in (python, python3, node, env, printenv)
      output: >
        Environment variable access (user=%user.name process=%proc.name
        command=%proc.cmdline pid=%proc.pid container=%container.name)
      priority: WARNING
      tags: [credentials, exfiltration, mitre_credential_access]
      source: syscall

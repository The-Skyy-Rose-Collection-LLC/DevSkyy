<!DOCTYPE html>
<!--
SkyyRose 3D Product Viewer
===========================
Three.js-based 3D product viewer for SkyyRose collection pages.
Supports GLB/GLTF models with orbit controls, lighting presets, and zoom.

Usage in Elementor:
  Add as Custom HTML widget or embed via WordPress shortcode.
  
WordPress Shortcode: [skyyrose_3d_viewer model_url="..." product_id="123"]

Author: DevSkyy Platform Team
Version: 1.0.0
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyyRose 3D Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .skyyrose-viewer-container {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            font-family: 'Inter', -apple-system, sans-serif;
        }
        
        #viewer-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }
        
        .viewer-btn {
            background: transparent;
            border: 1px solid rgba(212, 175, 55, 0.5);
            color: #D4AF37;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .viewer-btn:hover {
            background: #D4AF37;
            color: #1A1A1A;
        }
        
        .viewer-btn.active {
            background: #D4AF37;
            color: #1A1A1A;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #D4AF37;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(212, 175, 55, 0.2);
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            letter-spacing: 2px;
        }
        
        .viewer-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
        }
        
        .ar-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #D4AF37;
            color: #1A1A1A;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            display: none;
        }
        
        .ar-btn.visible { display: block; }
    </style>
</head>
<body>
    <div class="skyyrose-viewer-container" id="viewer-container">
        <canvas id="viewer-canvas"></canvas>
        
        <div class="loading-overlay" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">LOADING MODEL</div>
        </div>
        
        <div class="viewer-info">
            <span>Drag to rotate • Scroll to zoom • Double-click to reset</span>
        </div>
        
        <button class="ar-btn" id="ar-button">View in AR</button>
        
        <div class="viewer-controls">
            <button class="viewer-btn active" data-lighting="studio">Studio</button>
            <button class="viewer-btn" data-lighting="outdoor">Outdoor</button>
            <button class="viewer-btn" data-lighting="dramatic">Dramatic</button>
            <button class="viewer-btn" data-action="autorotate">Auto Rotate</button>
            <button class="viewer-btn" data-action="reset">Reset View</button>
        </div>
    </div>

    <!-- Three.js from CDN -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        // SkyyRose 3D Viewer Class
        class SkyyRoseViewer {
            constructor(container, options = {}) {
                this.container = container;
                this.canvas = container.querySelector('#viewer-canvas');
                this.options = {
                    modelUrl: options.modelUrl || container.dataset.modelUrl,
                    autoRotate: options.autoRotate ?? true,
                    rotateSpeed: options.rotateSpeed ?? 0.5,
                    backgroundColor: options.backgroundColor ?? 0x1A1A1A,
                    ...options
                };

                this.init();
            }

            init() {
                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(this.options.backgroundColor);

                // Camera
                const aspect = this.canvas.clientWidth / this.canvas.clientHeight;
                this.camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
                this.camera.position.set(0, 1, 3);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    antialias: true,
                    alpha: true
                });
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 1.2;
                this.renderer.outputColorSpace = THREE.SRGBColorSpace;

                // Controls
                this.controls = new OrbitControls(this.camera, this.canvas);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 1;
                this.controls.maxDistance = 10;
                this.controls.autoRotate = this.options.autoRotate;
                this.controls.autoRotateSpeed = this.options.rotateSpeed;

                // Default lighting (Studio)
                this.setupLighting('studio');

                // Load model
                if (this.options.modelUrl) {
                    this.loadModel(this.options.modelUrl);
                }

                // Events
                this.setupEvents();
                this.animate();
            }

            setupLighting(preset) {
                // Remove existing lights
                this.scene.children
                    .filter(c => c.isLight)
                    .forEach(l => this.scene.remove(l));

                const presets = {
                    studio: () => {
                        const key = new THREE.DirectionalLight(0xffffff, 1.5);
                        key.position.set(2, 3, 2);
                        const fill = new THREE.DirectionalLight(0xD4AF37, 0.5);
                        fill.position.set(-2, 1, -1);
                        const rim = new THREE.DirectionalLight(0xffffff, 0.8);
                        rim.position.set(0, 2, -3);
                        const ambient = new THREE.AmbientLight(0x404040, 0.5);
                        this.scene.add(key, fill, rim, ambient);
                    },
                    outdoor: () => {
                        const sun = new THREE.DirectionalLight(0xfff5e6, 2);
                        sun.position.set(5, 10, 5);
                        const sky = new THREE.HemisphereLight(0x87ceeb, 0x8b7355, 0.8);
                        this.scene.add(sun, sky);
                    },
                    dramatic: () => {
                        const spot = new THREE.SpotLight(0xD4AF37, 3, 10, Math.PI / 6);
                        spot.position.set(0, 5, 2);
                        const accent = new THREE.PointLight(0x8B0000, 1, 5);
                        accent.position.set(-2, 1, 0);
                        const ambient = new THREE.AmbientLight(0x1A1A1A, 0.3);
                        this.scene.add(spot, accent, ambient);
                    }
                };

                (presets[preset] || presets.studio)();
            }

            loadModel(url) {
                const loader = new GLTFLoader();
                const dracoLoader = new DRACOLoader();
                dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
                loader.setDRACOLoader(dracoLoader);

                loader.load(
                    url,
                    (gltf) => {
                        this.model = gltf.scene;

                        // Center and scale
                        const box = new THREE.Box3().setFromObject(this.model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 2 / maxDim;

                        this.model.scale.setScalar(scale);
                        this.model.position.sub(center.multiplyScalar(scale));

                        this.scene.add(this.model);
                        this.hideLoading();
                    },
                    (progress) => {
                        const pct = (progress.loaded / progress.total * 100).toFixed(0);
                        this.updateLoading(`LOADING ${pct}%`);
                    },
                    (error) => {
                        console.error('Model load error:', error);
                        this.updateLoading('LOAD ERROR');
                    }
                );
            }

            setupEvents() {
                // Resize
                window.addEventListener('resize', () => {
                    const width = this.container.clientWidth;
                    const height = this.container.clientHeight;
                    this.camera.aspect = width / height;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(width, height);
                });

                // Double-click reset
                this.canvas.addEventListener('dblclick', () => this.resetView());

                // Control buttons
                this.container.querySelectorAll('.viewer-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.handleButton(btn));
                });
            }

            handleButton(btn) {
                const lighting = btn.dataset.lighting;
                const action = btn.dataset.action;

                if (lighting) {
                    this.container.querySelectorAll('[data-lighting]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.setupLighting(lighting);
                }

                if (action === 'autorotate') {
                    this.controls.autoRotate = !this.controls.autoRotate;
                    btn.classList.toggle('active');
                }

                if (action === 'reset') this.resetView();
            }

            resetView() {
                this.camera.position.set(0, 1, 3);
                this.controls.target.set(0, 0, 0);
                this.controls.update();
            }

            hideLoading() {
                const loading = this.container.querySelector('#loading');
                if (loading) loading.style.display = 'none';
            }

            updateLoading(text) {
                const loadingText = this.container.querySelector('.loading-text');
                if (loadingText) loadingText.textContent = text;
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Initialize viewer
        const container = document.getElementById('viewer-container');
        const viewer = new SkyyRoseViewer(container, {
            modelUrl: container.dataset.modelUrl || null,
            autoRotate: true
        });

        // Export for WordPress integration
        window.SkyyRoseViewer = SkyyRoseViewer;
    </script>
</body>
</html>


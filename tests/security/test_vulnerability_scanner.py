"""
Security Vulnerability Scanner Tests
====================================

Comprehensive tests for the vulnerability scanning system.
Tests both npm and Python vulnerability detection and reporting.

Test Coverage:
- Vulnerability scanning functionality
- Report generation
- Error handling
- Security metrics

Dependencies: pytest, unittest.mock
"""

import json
import subprocess
from unittest.mock import Mock, patch

import pytest

from security.vulnerability_scanner import (
    SecurityMonitoringAgent,
    SecurityScanResult,
    SeverityLevel,
    Vulnerability,
)


class TestSecurityMonitoringAgent:
    """Test SecurityMonitoringAgent functionality."""

    @pytest.fixture
    def scanner(self, tmp_path):
        """Create scanner instance with temporary project root."""
        return SecurityMonitoringAgent(tmp_path)

    @pytest.fixture
    def mock_npm_audit_data(self):
        """Mock npm audit JSON output."""
        return {
            "vulnerabilities": {
                "test-package": {
                    "severity": "high",
                    "isDirect": True,
                    "range": ">=1.0.0",
                    "via": [
                        {
                            "source": 1234567,
                            "title": "Test vulnerability",
                            "url": "https://github.com/advisories/GHSA-test",
                        }
                    ],
                    "fixAvailable": {"version": "2.0.0"},
                }
            },
            "metadata": {
                "vulnerabilities": {"critical": 0, "high": 1, "moderate": 0, "low": 0, "total": 1}
            },
        }

    @pytest.fixture
    def mock_pip_audit_data(self):
        """Mock pip-audit JSON output."""
        return [
            {
                "package": "test-python-package",
                "installed_version": "1.0.0",
                "id": "CVE-2024-12345",
                "description": "Test Python vulnerability",
                "fixed_versions": ["1.1.0"],
            }
        ]

    def test_init(self, scanner, tmp_path):
        """Test scanner initialization."""
        assert scanner.project_root == tmp_path
        assert scanner.scan_results == []

    @patch("subprocess.run")
    def test_scan_npm_vulnerabilities_success(self, mock_run, scanner, mock_npm_audit_data):
        """Test successful npm vulnerability scan."""
        # Setup package.json
        (scanner.project_root / "package.json").touch()

        # Mock subprocess result
        mock_run.return_value = Mock(
            returncode=1,  # npm audit returns 1 when vulnerabilities found
            stdout=json.dumps(mock_npm_audit_data),
        )

        result = scanner._scan_npm_vulnerabilities()

        assert result is not None
        assert result.package_manager == "npm"
        assert result.total_count == 1
        assert len(result.vulnerabilities) == 1

        vuln = result.vulnerabilities[0]
        assert vuln.name == "test-package"
        assert vuln.severity == SeverityLevel.HIGH
        assert vuln.is_direct is True
        assert vuln.fix_available is True

    @patch("subprocess.run")
    def test_scan_npm_vulnerabilities_no_package_json(self, mock_run, scanner):
        """Test npm scan when package.json doesn't exist."""
        results = scanner.scan_all_vulnerabilities()

        # Should not attempt npm scan
        mock_run.assert_not_called()
        assert len(results) == 0

    @patch("subprocess.run")
    def test_scan_npm_vulnerabilities_timeout(self, mock_run, scanner):
        """Test npm scan timeout handling."""
        (scanner.project_root / "package.json").touch()

        mock_run.side_effect = subprocess.TimeoutExpired("npm", 60)

        result = scanner._scan_npm_vulnerabilities()
        assert result is None

    @patch("subprocess.run")
    def test_scan_python_vulnerabilities_success(self, mock_run, scanner, mock_pip_audit_data):
        """Test successful Python vulnerability scan."""
        # Setup requirements.txt
        (scanner.project_root / "requirements.txt").touch()

        # Mock subprocess result
        mock_run.return_value = Mock(returncode=0, stdout=json.dumps(mock_pip_audit_data))

        result = scanner._scan_python_vulnerabilities()

        assert result is not None
        assert result.package_manager == "pip"
        assert len(result.vulnerabilities) == 1

        vuln = result.vulnerabilities[0]
        assert vuln.name == "test-python-package"
        assert vuln.cve_id == "CVE-2024-12345"
        assert vuln.fixed_version == "1.1.0"

    @patch("subprocess.run")
    def test_scan_python_vulnerabilities_not_available(self, mock_run, scanner):
        """Test Python scan when pip-audit not available."""
        (scanner.project_root / "requirements.txt").touch()

        mock_run.side_effect = FileNotFoundError()

        result = scanner._scan_python_vulnerabilities()
        assert result is None

    def test_parse_npm_audit_results(self, scanner, mock_npm_audit_data):
        """Test parsing npm audit results."""
        result = scanner._parse_npm_audit_results(mock_npm_audit_data)

        assert isinstance(result, SecurityScanResult)
        assert result.total_count == 1
        assert result.severity_counts[SeverityLevel.HIGH] == 1
        assert len(result.vulnerabilities) == 1

    def test_parse_pip_audit_results(self, scanner, mock_pip_audit_data):
        """Test parsing pip audit results."""
        result = scanner._parse_pip_audit_results(mock_pip_audit_data)

        assert isinstance(result, SecurityScanResult)
        assert result.total_count == 1
        assert len(result.vulnerabilities) == 1

    def test_extract_fixed_version(self, scanner):
        """Test extracting fixed version from vulnerability data."""
        # Test with dict fix_available
        vuln_data = {"fixAvailable": {"version": "2.0.0"}}
        assert scanner._extract_fixed_version(vuln_data) == "2.0.0"

        # Test with boolean fix_available
        vuln_data = {"fixAvailable": True}
        assert scanner._extract_fixed_version(vuln_data) is None

        # Test with no fix_available
        vuln_data = {}
        assert scanner._extract_fixed_version(vuln_data) is None

    @patch("security.vulnerability_scanner.SecurityMonitoringAgent._scan_npm_vulnerabilities")
    @patch("security.vulnerability_scanner.SecurityMonitoringAgent._scan_python_vulnerabilities")
    def test_scan_all_vulnerabilities(self, mock_python_scan, mock_npm_scan, scanner):
        """Test comprehensive vulnerability scanning."""
        # Setup files
        (scanner.project_root / "package.json").touch()
        (scanner.project_root / "requirements.txt").touch()

        # Mock scan results
        npm_result = Mock(spec=SecurityScanResult)
        python_result = Mock(spec=SecurityScanResult)

        mock_npm_scan.return_value = npm_result
        mock_python_scan.return_value = python_result

        results = scanner.scan_all_vulnerabilities()

        assert len(results) == 2
        assert npm_result in results
        assert python_result in results
        assert scanner.scan_results == results

    def test_generate_security_report_no_results(self, scanner):
        """Test report generation with no scan results."""
        report = scanner.generate_security_report()
        assert "No security scan results available." in report

    def test_generate_security_report_with_results(self, scanner):
        """Test report generation with scan results."""
        # Create mock vulnerability
        vuln = Vulnerability(
            name="test-package",
            severity=SeverityLevel.HIGH,
            cve_id="CVE-2024-12345",
            description="Test vulnerability",
            affected_versions=">=1.0.0",
            fixed_version="2.0.0",
            package_manager="npm",
            is_direct=True,
            fix_available=True,
        )

        # Create mock scan result
        scan_result = SecurityScanResult(
            vulnerabilities=[vuln],
            total_count=1,
            severity_counts={
                SeverityLevel.CRITICAL: 0,
                SeverityLevel.HIGH: 1,
                SeverityLevel.MODERATE: 0,
                SeverityLevel.LOW: 0,
                SeverityLevel.INFO: 0,
            },
            scan_timestamp="2024-01-01 00:00:00",
            package_manager="npm",
        )

        scanner.scan_results = [scan_result]

        report = scanner.generate_security_report()

        assert "DevSkyy Security Vulnerability Report" in report
        assert "Total Vulnerabilities Found:** 1" in report  # Markdown format with bold
        assert "High:** 1" in report  # Markdown format
        assert "test-package" in report
        assert "CVE-2024-12345" in report

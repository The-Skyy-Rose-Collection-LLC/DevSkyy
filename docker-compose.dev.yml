# ============================================================================
# DevSkyy Enterprise Platform - Development Docker Compose
# Version: 5.2.0 | Development Environment with Hot Reload
# ============================================================================
# Usage: docker-compose -f docker-compose.dev.yml up
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # DevSkyy API (Development Mode)
  # ============================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      args:
        PYTHON_VERSION: 3.11
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD)}
    image: devskyy:dev
    container_name: devskyy-api-dev
    restart: unless-stopped
    ports:
      - "8000:8000"  # API
      - "5678:5678"  # Debugger port
    environment:
      # Application
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - RELOAD=true

      # Secrets (from .env file)
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-me}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-devskyy}:${POSTGRES_PASSWORD:-devpassword}@postgres:5432/${POSTGRES_DB:-devskyy}

      # Cache
      - REDIS_URL=redis://redis:6379/0

      # Development Features
      - PYTHONBREAKPOINT=debugpy.breakpoint
    volumes:
      # Source code hot reload
      - ./:/app:delegated
      # Persistent data
      - dev-data:/app/data
      - dev-logs:/app/logs
      - dev-artifacts:/app/artifacts
      # Cache pip packages to speed up rebuilds
      - pip-cache:/home/devskyy/.cache/pip
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - devskyy-dev-network
    command: >
      sh -c "
        echo 'Starting DevSkyy in DEVELOPMENT mode...' &&
        python -m uvicorn main:app
          --host 0.0.0.0
          --port 8000
          --reload
          --log-level debug
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # PostgreSQL Database (Development)
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: devskyy-postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-devskyy}
      POSTGRES_USER: ${POSTGRES_USER:-devskyy}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      # Development: Enable connection logging
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres-dev-data:/var/lib/postgresql/data
      - ./docker/init-db:/docker-entrypoint-initdb.d:ro
    networks:
      - devskyy-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-devskyy}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================================
  # Redis Cache (Development)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: devskyy-redis-dev
    restart: unless-stopped
    command: >
      redis-server
        --maxmemory 256mb
        --maxmemory-policy allkeys-lru
        --appendonly yes
        --appendfsync everysec
        --loglevel debug
    ports:
      - "6379:6379"
    volumes:
      - redis-dev-data:/data
    networks:
      - devskyy-dev-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================================================
  # Adminer (Database Management UI)
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: devskyy-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    networks:
      - devskyy-dev-network
    depends_on:
      - postgres

  # ============================================================================
  # Redis Commander (Redis Management UI)
  # ============================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: devskyy-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "8081:8081"
    networks:
      - devskyy-dev-network
    depends_on:
      - redis

  # ============================================================================
  # Mailhog (Email Testing)
  # ============================================================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: devskyy-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - devskyy-dev-network

# ============================================================================
# VOLUMES (Development)
# ============================================================================
volumes:
  postgres-dev-data:
    driver: local
  redis-dev-data:
    driver: local
  dev-data:
    driver: local
  dev-logs:
    driver: local
  dev-artifacts:
    driver: local
  pip-cache:
    driver: local

# ============================================================================
# NETWORKS (Development)
# ============================================================================
networks:
  devskyy-dev-network:
    driver: bridge
    name: devskyy-dev

# ============================================================================
# DEVELOPMENT USAGE INSTRUCTIONS
# ============================================================================
# Start development environment:
#   docker-compose -f docker-compose.dev.yml up -d
#
# View logs:
#   docker-compose -f docker-compose.dev.yml logs -f api
#
# Access services:
#   - API: http://localhost:8000
#   - API Docs: http://localhost:8000/docs
#   - Database UI: http://localhost:8080 (Adminer)
#   - Redis UI: http://localhost:8081 (Redis Commander)
#   - Email UI: http://localhost:8025 (Mailhog)
#
# Run tests inside container:
#   docker-compose -f docker-compose.dev.yml exec api pytest
#
# Shell access:
#   docker-compose -f docker-compose.dev.yml exec api bash
#
# Stop and cleanup:
#   docker-compose -f docker-compose.dev.yml down -v
# ============================================================================

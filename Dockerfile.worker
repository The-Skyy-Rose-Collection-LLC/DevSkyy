# DevSkyy Worker - Lightweight build (no frontend, just worker)
# Use this for testing hybrid integration

FROM python:3.11-slim

# Prevent apt from hanging
ENV DEBIAN_FRONTEND=noninteractive

# Set Python environment
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# Install system dependencies with retry logic
# Enterprise hardening: apt-get with retry logic and timeout
RUN apt-get update --fix-missing || apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
        curl \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy requirements
COPY requirements.txt .

# Install Python dependencies with timeout
# Enterprise hardening: pip timeout prevents hanging on network issues
RUN pip install --no-cache-dir --timeout=300 -r requirements.txt

# Copy application code
COPY agent_sdk/ ./agent_sdk/
COPY agents/ ./agents/
COPY llm/ ./llm/
COPY orchestration/ ./orchestration/
COPY core/ ./core/
COPY security/ ./security/

# Create non-root user
RUN useradd -m -u 1000 worker && \
    chown -R worker:worker /app

USER worker

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import redis.asyncio as r; import asyncio; asyncio.run(r.from_url('${REDIS_URL}').ping())" || exit 1

# Run worker
CMD ["python", "-m", "agent_sdk.worker"]
